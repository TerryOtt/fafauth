# "org" ensures this Service is used with the correct Serverless Framework Access Key.
org: firsttracks

# "app" enables Serverless Framework Dashboard features and sharing them with other Services.
app: fafauth-api

# "service" is the name of this project. This will also be added to your AWS resource names.
service: fafauth


provider:
  name: aws
  region: af-south-1
  runtime: python3.14
  httpApi:
    authorizers:
      customAuthorizer:
        type: request
        functionName: apiCustomAuthorizer 
        enableSimpleResponses: true # Enable simple response format
        payloadVersion: '2.0' # Use payload version 2.0, required for simple response format

  # IAM setup to create an IAM role which can read Parameter Store path containing the JWKS which
  #     hopefully is the one which signed all bearer tokens presented to our API
  #
  # See: https://www.serverless.com/framework/docs/providers/aws/guide/iam
  iam:
    role:
      name: fafauth-read-jwks
      statements:
        # Permission to get exactly one specific parameter
        - Effect: 'Allow'
          Action:
            - 'ssm:GetParameter'
          Resource:
            - 'arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/fafauth/apigw_custom_authorizer/client_token_signing_keys_jwks'


functions:
  apiCustomAuthorizer:
      handler: authorizer.custom_authorizer

  ping:
    handler: handler.ping
    memorySize: 1769
    events:
      - httpApi:
          path: /api/v001/ping
          method: get

  getUserInfo:
    handler: handler.get_user_info
    memorySize: 1769
    events:
      - httpApi:
          path: /api/v001/user
          method: get
          authorizer:
            name: customAuthorizer


# Needed to install everything in requirements.txt
custom:
  pythonRequirements:
    dockerizePip: true
